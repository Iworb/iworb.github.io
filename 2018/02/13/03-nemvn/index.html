<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="Just another one developer blog, who looked for Holy grail">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      Full Stack (Node + Express + MongoDb + Vue + Nuxt) application. Part 3: Logging, initialization splitting and more helpers | Iworb&#39;s blog
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  <script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


</head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Iworb's blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archive</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About me</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archive</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About me</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Full Stack (Node + Express + MongoDb + Vue + Nuxt) application. Part 3: Logging, initialization splitting and more helpers</h2>
  <p class="post-date">2018-02-13</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h2 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h2><p>Console logging is good, but it doesn’t cover all needs. Server could turn off instantly and you won’t see any messages, or there’s plenty errors and you have no time to read a single one, etc.<br>Let’s take a look for other logging variations.<br>There’s already good module to achieve different behaviours:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add winston</span><br></pre></td></tr></table></figure></p>
<p>Files, belong using for init our application and other nifty functions which require config will land into <code>server/engine</code> directory. Make sure to include it into your module aliases list:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;@engine&quot;: &quot;./server/engine&quot;</span><br></pre></td></tr></table></figure></p>
<p>Lets make a new file <code>logger.js</code> with console output:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> winston = <span class="built_in">require</span>(<span class="string">'winston'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'@config'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;env&#125; = <span class="built_in">require</span>(<span class="string">'@helpers'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> transports = []</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Console transporter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">transports.push(<span class="keyword">new</span> winston.transports.Console(&#123;</span><br><span class="line">  level: config.logging.console.level,</span><br><span class="line">  colorize: <span class="literal">true</span>,</span><br><span class="line">  prettyPrint: <span class="literal">true</span>,</span><br><span class="line">  handleExceptions: env.isProduction()</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// [before]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = <span class="keyword">new</span> winston.Logger(&#123;</span><br><span class="line">  level: <span class="string">'debug'</span>,</span><br><span class="line">  transports: transports,</span><br><span class="line">  exitOnError: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// [after]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = logger</span><br></pre></td></tr></table></figure></p>
<p>As you can see we’re using <code>config.logging.console.level</code> variable to define level of console logging. Let’s extend our <code>config.template.js</code> for logging:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logging: &#123;</span><br><span class="line">  <span class="built_in">console</span>: &#123;</span><br><span class="line">    level: <span class="string">'debug'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We could redefine this level for some environments. For production we could use this:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logging: &#123;</span><br><span class="line">  <span class="built_in">console</span>: &#123;</span><br><span class="line">    level: <span class="string">'error'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Further loggers require some additional packages to install, some config and init function which should be placed [before] or [after] logger init.</p>
<h3 id="File-before"><a href="#File-before" class="headerlink" title="File [before]"></a>File [before]</h3><p>packages:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add mkdirp winston-daily-rotate-file</span><br></pre></td></tr></table></figure></p>
<p>config:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">file: &#123;</span><br><span class="line">  enabled: <span class="literal">true</span>,</span><br><span class="line">  path: path.normalize(path.join(__dirname, <span class="string">'..'</span>, <span class="string">'..'</span>, <span class="string">'logs'</span>)),</span><br><span class="line">  level: <span class="string">'info'</span>,</span><br><span class="line">  json: <span class="literal">false</span>,</span><br><span class="line">  exceptionFile: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>NB: you should add <code>const path = require(&#39;path&#39;)</code> at the begin of your config files if you use <code>path</code>.<br>init:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mkdirp = <span class="built_in">require</span>(<span class="string">'mkdirp'</span>)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * File transporter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (config.logging.file.enabled) &#123;</span><br><span class="line">  <span class="comment">// Create logs directory</span></span><br><span class="line">  <span class="keyword">const</span> logDir = config.logging.file.path</span><br><span class="line">  <span class="keyword">if</span> (!fs.existsSync(logDir)) &#123;</span><br><span class="line">    mkdirp(logDir)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  transports.push(<span class="keyword">new</span> (<span class="built_in">require</span>(<span class="string">'winston-daily-rotate-file'</span>))(&#123;</span><br><span class="line">    filename: path.join(logDir, <span class="string">'server.log'</span>),</span><br><span class="line">    level: config.logging.file.level || <span class="string">'info'</span>,</span><br><span class="line">    timestamp: <span class="literal">true</span>,</span><br><span class="line">    json: config.logging.file.json || <span class="literal">false</span>,</span><br><span class="line">    handleExceptions: <span class="literal">true</span></span><br><span class="line">  &#125;))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config.logging.file.exceptionFile) &#123;</span><br><span class="line">    transports.push(<span class="keyword">new</span> winston.transports.File(&#123;</span><br><span class="line">      filename: path.join(logDir, <span class="string">'exceptions.log'</span>),</span><br><span class="line">      level: <span class="string">'error'</span>,</span><br><span class="line">      timestamp: <span class="literal">true</span>,</span><br><span class="line">      json: config.logging.file.json || <span class="literal">false</span>,</span><br><span class="line">      prettyPrint: <span class="literal">true</span>,</span><br><span class="line">      handleExceptions: <span class="literal">true</span>,</span><br><span class="line">      humanReadableUnhandledException: <span class="literal">true</span></span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Logentries-before"><a href="#Logentries-before" class="headerlink" title="Logentries [before]"></a><a href="https://logentries.com/" target="_blank" rel="noopener">Logentries</a> [before]</h3><p>packages:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add le_node</span><br></pre></td></tr></table></figure></p>
<p>config:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logentries: &#123;</span><br><span class="line">  enabled: <span class="literal">false</span>,</span><br><span class="line">  token: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>init:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logentries transporter</span></span><br><span class="line"><span class="comment"> * https://logentries.com/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (config.logging.logentries.enabled &amp;&amp; config.logging.logentries.token) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Logentries log transport enabled!'</span>)</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'le_node'</span>)</span><br><span class="line">  transports.push(<span class="keyword">new</span> winston.transports.Logentries(&#123;</span><br><span class="line">    level: <span class="string">'debug'</span>,</span><br><span class="line">    token: config.logging.logentries.token</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Papertrail-before"><a href="#Papertrail-before" class="headerlink" title="Papertrail [before]"></a><a href="https://papertrailapp.com/" target="_blank" rel="noopener">Papertrail</a> [before]</h3><p>packages:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add winston-papertrail</span><br></pre></td></tr></table></figure></p>
<p>config:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">papertrail: &#123;</span><br><span class="line">  enabled: <span class="literal">false</span>,</span><br><span class="line">  host: <span class="literal">null</span>,</span><br><span class="line">  port: <span class="literal">null</span>,</span><br><span class="line">  level: <span class="string">'debug'</span>,</span><br><span class="line">  program: <span class="string">'vem'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>init:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Papertrail transporter</span></span><br><span class="line"><span class="comment"> * https://papertrailapp.com/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (config.logging.papertrail.enabled) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Papertrail log transport enabled!'</span>)</span><br><span class="line">  <span class="comment">// eslint-disable-next-line no-unused-expressions</span></span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'winston-papertrail'</span>).Papertrail</span><br><span class="line">  transports.push(<span class="keyword">new</span> winston.transports.Papertrail(config.logging.papertrail))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Loggly-after"><a href="#Loggly-after" class="headerlink" title="Loggly [after]"></a><a href="https://www.loggly.com/" target="_blank" rel="noopener">Loggly</a> [after]</h3><p>packages:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add winston-loggly-bulk</span><br></pre></td></tr></table></figure></p>
<p>config:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">loggly: &#123;</span><br><span class="line">  enabled: <span class="literal">false</span>,</span><br><span class="line">  token: <span class="literal">null</span>,</span><br><span class="line">  subdomain: <span class="literal">null</span>,</span><br><span class="line">  tags: [],</span><br><span class="line">  json: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>init:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Loggly transporter</span></span><br><span class="line"><span class="comment"> * https://www.loggly.com/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (config.logging.loggly.enabled &amp;&amp; config.logging.loggly.token) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Loggly log transport enabled!'</span>)</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'winston-loggly-bulk'</span>)</span><br><span class="line">  logger.add(winston.transports.Loggly, &#123;</span><br><span class="line">    inputToken: config.logging.loggly.token,</span><br><span class="line">    subdomain: config.logging.loggly.subdomain,</span><br><span class="line">    tags: config.logging.loggly.tags,</span><br><span class="line">    json: config.logging.loggly.json</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Logsene-after"><a href="#Logsene-after" class="headerlink" title="Logsene [after]"></a><a href="https://sematext.com/logsene/" target="_blank" rel="noopener">Logsene</a> [after]</h3><p>packages:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add winston-logsene</span><br></pre></td></tr></table></figure></p>
<p>config:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logsene: &#123;</span><br><span class="line">  enabled: <span class="literal">false</span>,</span><br><span class="line">  token: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>init:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logsene transporter</span></span><br><span class="line"><span class="comment"> * https://sematext.com/logsene/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (config.logging.logsene.enabled &amp;&amp; config.logging.logsene.token) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Logsene log transport enabled!'</span>)</span><br><span class="line">  <span class="keyword">const</span> logsene = <span class="built_in">require</span>(<span class="string">'winston-logsene'</span>)</span><br><span class="line">  logger.add(logsene, &#123;</span><br><span class="line">    type: <span class="string">'vem-server'</span>,</span><br><span class="line">    token: config.logging.logsene.token</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Logz-io-after"><a href="#Logz-io-after" class="headerlink" title="Logz.io [after]"></a><a href="https://logz.io/" target="_blank" rel="noopener">Logz.io</a> [after]</h3><p>packages:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add winston-logzio</span><br></pre></td></tr></table></figure></p>
<p>config:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logzio: &#123;</span><br><span class="line">  enabled: <span class="literal">false</span>,</span><br><span class="line">  token: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>init:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logz.io transporter</span></span><br><span class="line"><span class="comment"> * https://logz.io/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (config.logging.logzio.enabled &amp;&amp; config.logging.logzio.token) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Logz.io log transport enabled!'</span>)</span><br><span class="line">  <span class="keyword">const</span> logzio = <span class="built_in">require</span>(<span class="string">'winston-logzio'</span>)</span><br><span class="line">  logger.add(logzio, &#123;</span><br><span class="line">    token: config.logging.logzio.token</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Graylog-after"><a href="#Graylog-after" class="headerlink" title="Graylog [after]"></a><a href="https://www.graylog.org/" target="_blank" rel="noopener">Graylog</a> [after]</h3><p>packages:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add winston-graylog2</span><br></pre></td></tr></table></figure></p>
<p>config:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graylog: &#123;</span><br><span class="line">  enabled: <span class="literal">false</span>,</span><br><span class="line">  servers: [&#123;<span class="attr">host</span>: <span class="string">'192.168.1.100'</span>, <span class="attr">port</span>: <span class="number">12201</span>&#125;],</span><br><span class="line">  facility: <span class="string">'MEVN'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>init:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Graylog transporter</span></span><br><span class="line"><span class="comment"> * https://www.graylog.org/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (config.logging.graylog.enabled) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Graylog log transport enabled! Servers: '</span> + <span class="built_in">JSON</span>.stringify(config.logging.graylog.servers))</span><br><span class="line">  <span class="keyword">let</span> graylog = <span class="built_in">require</span>(<span class="string">'winston-graylog2'</span>)</span><br><span class="line">  logger.add(graylog, &#123;</span><br><span class="line">    name: <span class="string">'Graylog'</span>,</span><br><span class="line">    level: <span class="string">'debug'</span>,</span><br><span class="line">    graylog: &#123;</span><br><span class="line">      servers: config.logging.graylog.servers,</span><br><span class="line">      facility: config.logging.graylog.facility</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Entry-point"><a href="#Entry-point" class="headerlink" title="Entry point"></a>Entry point</h2><p>Our <code>server/index.js</code> intended for complete server init and have a lot of stuff to init to. Now there’s just express, sessions and nuxt init, but this file will grow. Best practice is split this file.<br>We already have an <code>engine</code> directory, so let’s move our express initialization into <code>express.js</code> file located in the <code>engine</code> directory:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'@config'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;env&#125; = <span class="built_in">require</span>(<span class="string">'@helpers'</span>)</span><br><span class="line"><span class="keyword">const</span> nuxtConfig = <span class="built_in">require</span>(<span class="string">'@/nuxt.config'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>)</span><br><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;Nuxt, Builder&#125; = <span class="built_in">require</span>(<span class="string">'nuxt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize middlewares</span></span><br><span class="line"><span class="comment"> * @param &#123;any&#125; app</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initMiddleware</span> (<span class="params">app</span>) </span>&#123;</span><br><span class="line">  app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">    extended: <span class="literal">true</span></span><br><span class="line">  &#125;))</span><br><span class="line">  app.use(bodyParser.json())</span><br><span class="line">  app.use(cookieParser())</span><br><span class="line">  app.set(<span class="string">'etag'</span>, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize session</span></span><br><span class="line"><span class="comment"> * @param &#123;any&#125; app</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initSession</span> (<span class="params">app</span>) </span>&#123;</span><br><span class="line">  app.use(session(config.session))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize Nuxt</span></span><br><span class="line"><span class="comment"> * @param &#123;any&#125; app</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initNuxt</span> (<span class="params">app</span>) </span>&#123;</span><br><span class="line">  nuxtConfig.dev = !env.isProduction()</span><br><span class="line">  <span class="keyword">const</span> nuxt = <span class="keyword">new</span> Nuxt(nuxtConfig)</span><br><span class="line">  <span class="keyword">if</span> (nuxtConfig.dev) &#123;</span><br><span class="line">    <span class="keyword">new</span> Builder(nuxt).build()</span><br><span class="line">  &#125;</span><br><span class="line">  app.use(nuxt.render)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">  initMiddleware(app)</span><br><span class="line">  initSession(app)</span><br><span class="line">  initNuxt(app)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>server/index.js</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'module-alias/register'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'@engine/express'</span>)()</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Application was started at the 3000th port`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">exports = <span class="built_in">module</span>.exports = app</span><br></pre></td></tr></table></figure></p>
<p>It looks much better now, isn’t it?<br>We also split our middlewares just for make sure we’re using it in right order.</p>
<h2 id="Express-extras"><a href="#Express-extras" class="headerlink" title="Express extras"></a>Express extras</h2><p>First of all, lets define <code>ip</code> and <code>port</code> in our configs:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip: process.env.NODE_IP || <span class="string">'0.0.0.0'</span>,</span><br><span class="line">port: process.env.NODE_PORT || <span class="number">3000</span></span><br></pre></td></tr></table></figure></p>
<p>Now we could add little bit more logging information on server start:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'module-alias/register'</span>)</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'@config'</span>)</span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'@engine/logger'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>)</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'@engine/express'</span>)()</span><br><span class="line"></span><br><span class="line">logger.info(chalk.bold(<span class="string">'-----------------[ Server starting at %s ]-----------------'</span>), moment().format(<span class="string">'YYYY-MM-DD HH:mm:ss.SSS'</span>))</span><br><span class="line"></span><br><span class="line">app.listen(config.port, config.ip, () =&gt; &#123;</span><br><span class="line">  logger.info(<span class="string">'----------------------------[ Application started! ]----------------------------'</span>)</span><br><span class="line">  logger.info(<span class="string">`Environment:\t<span class="subst">$&#123;chalk.underline.bold(process.env.NODE_ENV)&#125;</span>`</span>)</span><br><span class="line">  logger.info(<span class="string">`IP:\t\t\t<span class="subst">$&#123;config.ip&#125;</span>`</span>)</span><br><span class="line">  logger.info(<span class="string">`Port:\t\t\t<span class="subst">$&#123;config.port&#125;</span>`</span>)</span><br><span class="line">  logger.info(<span class="string">'--------------------------------------------------------------------------------'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">exports = <span class="built_in">module</span>.exports = app</span><br></pre></td></tr></table></figure></p>
<h3 id="Compression"><a href="#Compression" class="headerlink" title="Compression"></a>Compression</h3><p>This package will compress server response.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add compression</span><br></pre></td></tr></table></figure></p>
<p>Include this into middlewares list of <code>express.js</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compress = <span class="built_in">require</span>(<span class="string">'compression'</span>)</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initMiddleware</span> (<span class="params">app</span>) </span>&#123;</span><br><span class="line">  app.use(compress(&#123;</span><br><span class="line">    filter: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="regexp">/json|text|javascript|css/</span>.test(res.getHeader(<span class="string">'Content-Type'</span>))</span><br><span class="line">    &#125;,</span><br><span class="line">    level: <span class="number">3</span>,</span><br><span class="line">    threshold: <span class="number">512</span></span><br><span class="line">  &#125;))</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Morgan"><a href="#Morgan" class="headerlink" title="Morgan"></a>Morgan</h3><p>It’s usefull to know what requests your server got. That’s why I recommend to include <code>morgan</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add morgan</span><br></pre></td></tr></table></figure></p>
<p><code>express.js</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'@engine/logger'</span>)</span><br><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>)</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initMiddleware</span> (<span class="params">app</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (env.isDev()) &#123;</span><br><span class="line">    <span class="keyword">const</span> Stream = <span class="built_in">require</span>(<span class="string">'stream'</span>).Stream</span><br><span class="line">    <span class="keyword">const</span> mlStream = <span class="keyword">new</span> Stream()</span><br><span class="line">    mlStream.writable = <span class="literal">true</span></span><br><span class="line">    mlStream.write = <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> logger.debug(data)</span><br><span class="line">    &#125;</span><br><span class="line">    app.use(morgan(<span class="string">'dev'</span>, &#123;</span><br><span class="line">      stream: mlStream</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>This config using our <code>winston</code> logger for <code>morgan</code>.</p>
<h3 id="Helmet"><a href="#Helmet" class="headerlink" title="Helmet"></a>Helmet</h3><p>This little middleware adds some protection for requests to prevent some attacks.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add helmet</span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">'helmet'</span>)</span><br><span class="line">...</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initiliaze Helmet security module</span></span><br><span class="line"><span class="comment"> * @param &#123;any&#125; app</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initHelmetHeaders</span> (<span class="params">app</span>) </span>&#123;</span><br><span class="line">  app.use(helmet.xssFilter())</span><br><span class="line">  app.use(helmet.noSniff())</span><br><span class="line">  app.use(helmet.frameguard())</span><br><span class="line">  app.use(helmet.ieNoOpen())</span><br><span class="line">  app.use(helmet.hidePoweredBy())</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">  initMiddleware(app)</span><br><span class="line">  initHelmetHeaders(app)</span><br><span class="line">  initSession(app)</span><br><span class="line">  initNuxt(app)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Extra-helpers"><a href="#Extra-helpers" class="headerlink" title="Extra helpers"></a>Extra helpers</h2><h3 id="Safe-stop"><a href="#Safe-stop" class="headerlink" title="Safe stop"></a>Safe stop</h3><p>For further work we have to be sure server stopped correctly, all connections closed, etc. So let’s make new helper <code>safeStop.js</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'@engine/logger'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>)</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> smoothExit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> exit = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    logger.info()</span><br><span class="line">    logger.info(chalk.bold(<span class="string">'------[ Server stopped at %s Uptime: %s ]------'</span>), moment().format(<span class="string">'YYYY-MM-DD HH:mm:ss.SSS'</span>), moment.duration(process.uptime() * <span class="number">1000</span>).humanize())</span><br><span class="line">    <span class="keyword">return</span> process.exit(<span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> exit()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">process.on(<span class="string">'SIGINT'</span>, smoothExit).on(<span class="string">'SIGTERM'</span>, smoothExit)</span><br></pre></td></tr></table></figure></p>
<p>And call this in the <code>server/index.js</code> before <code>app.listen</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'@helpers/safeStop'</span>)</span><br><span class="line">...</span><br><span class="line">app.listen(...)</span><br></pre></td></tr></table></figure></p>
<h3 id="System-info"><a href="#System-info" class="headerlink" title="System info"></a>System info</h3><p>Let’s print information about system where server started. Make <code>sysinfo.js</code> helper.<br>It require some additional packages:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add clui pretty-bytes</span><br></pre></td></tr></table></figure></p>
<p><code>server/helpers/sysinfo.js</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'@engine/logger'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>)</span><br><span class="line"><span class="keyword">const</span> gauge = <span class="built_in">require</span>(<span class="string">'clui'</span>).Gauge</span><br><span class="line"><span class="keyword">const</span> pretty = <span class="built_in">require</span>(<span class="string">'pretty-bytes'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> total = os.totalmem()</span><br><span class="line"><span class="keyword">const</span> free = os.freemem()</span><br><span class="line"><span class="keyword">const</span> used = total - free</span><br><span class="line"><span class="keyword">const</span> human = pretty(free)</span><br><span class="line"></span><br><span class="line">logger.info(<span class="string">`CPU:\t\t\tArch: <span class="subst">$&#123;os.arch()&#125;</span>, Cores: <span class="subst">$&#123;os.cpus().length&#125;</span>`</span>)</span><br><span class="line">logger.info(<span class="string">`Memory:\t\t<span class="subst">$&#123;gauge(used, total, <span class="number">20</span>, total * <span class="number">0.8</span>, human + <span class="string">' free'</span>)&#125;</span>`</span>)</span><br><span class="line">logger.info(<span class="string">`OS:\t\t\t<span class="subst">$&#123;os.platform()&#125;</span> (<span class="subst">$&#123;os.type()&#125;</span>)`</span>)</span><br></pre></td></tr></table></figure></p>
<p>And call him after server start inside <code>app.listen</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.listen(..., () =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'@helpers/sysinfo'</span>)</span><br><span class="line">  logger.info(<span class="string">'--------------------------------------------------------------------------------'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>This part wraps up <code>03-logging-split-extras</code> git branch.</p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#express" >
    <span class="tag-code">express</span>
  </a>

  <a href="/tags#log" >
    <span class="tag-code">log</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2018/02/13/02-nemvn/">
        <span class="nav-arrow">← </span>
        
          Full Stack (Node + Express + MongoDb + Vue + Nuxt) application. Part 2: Helpers, Configs and Session
        
      </a>
    
    
      <a class="nav-right" href="/2018/02/13/04-nemvn/">
        
          Full Stack (Node + Express + MongoDb + Vue + Nuxt) application. Part 4: MongoDb
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
    <!-- 二维码 END -->
    
      <!-- Gitment START -->
      <div id="comments"></div>
      <!-- Gitment END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Logging"><span class="toc-nav-text">Logging</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#File-before"><span class="toc-nav-text">File [before]</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Logentries-before"><span class="toc-nav-text">Logentries [before]</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Papertrail-before"><span class="toc-nav-text">Papertrail [before]</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Loggly-after"><span class="toc-nav-text">Loggly [after]</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Logsene-after"><span class="toc-nav-text">Logsene [after]</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Logz-io-after"><span class="toc-nav-text">Logz.io [after]</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Graylog-after"><span class="toc-nav-text">Graylog [after]</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Entry-point"><span class="toc-nav-text">Entry point</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Express-extras"><span class="toc-nav-text">Express extras</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Compression"><span class="toc-nav-text">Compression</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Morgan"><span class="toc-nav-text">Morgan</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Helmet"><span class="toc-nav-text">Helmet</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Extra-helpers"><span class="toc-nav-text">Extra helpers</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Safe-stop"><span class="toc-nav-text">Safe stop</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#System-info"><span class="toc-nav-text">System info</span></a></li></ol></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://iworb.github.io/2018/02/13/03-nemvn/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()
        
        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "iworb";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "Full Stack (Node + Express + MongoDb + Vue + Nuxt) application. Part 3: Logging, initialization splitting and more helpers",
        owner: "iworb",
        repo: "iworb.github.io",
        oauth: {
          client_id: "fc37e05eb55faa187774",
          client_secret: "5f04db8e93239c8bded02d72e698c87a985f428c"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "ru-RU"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2018 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>
  </body>
</html>